# 202507030150_計画_コード品質改善計画

## 概要
graph_postgres_managerプロジェクトのコード品質検査結果と改善計画

## 現状分析

### テスト実行結果
- **実行テスト数**: 33件
- **成功**: 20件 
- **失敗**: 1件
- **エラー**: 12件
- **カバレッジ**: 39%（目標: 80%以上）

### 主な問題点

#### 1. インポートエラー
- `psycopg.pool`モジュールのインポート問題（対応済み）
- `ConnectionError` → `ConnectionException`の名前不一致（対応済み）

#### 2. 設定パラメータの不一致
- `conftest.py`で使用している`neo4j_user`などのパラメータが`ConnectionConfig`で未定義
- 環境変数からの設定読み込みで期待値と実際の値が異なる

#### 3. 低いテストカバレッジ
- 全体カバレッジ: 39%
- 特に低い部分:
  - `connections/neo4j.py`: 20%
  - `connections/postgres.py`: 23%
  - `manager.py`: 27%
  - `connections/base.py`: 38%

#### 4. 統合テストの設定問題
- `wait_for_services`フィクスチャの非同期処理警告
- Docker環境での接続設定の不一致

## 改善計画

### フェーズ1: テスト環境の修正（優先度: 高）
1. **ConnectionConfigの修正**
   - conftest.pyで使用されているパラメータ名に合わせてConnectionConfigを更新
   - または、conftest.pyを現在のConnectionConfigに合わせて修正

2. **環境変数の整合性確保**
   - Docker環境とテストの期待値を統一
   - 特に`neo4j_uri`のデフォルト値を調整

3. **非同期フィクスチャの修正**
   - `wait_for_services`の実装を確認し、適切に非同期処理を行う

### フェーズ2: カバレッジの向上（優先度: 中）
1. **接続クラスのテスト強化**
   - Neo4jConnectionクラスの単体テスト追加
   - PostgresConnectionクラスの単体テスト追加
   - エラーハンドリングのテスト追加

2. **マネージャークラスのテスト**
   - GraphPostgresManagerの各メソッドのテスト
   - トランザクション管理のテスト
   - 例外処理のテスト

3. **モックを使用した単体テスト**
   - 外部依存を減らすためのモック活用
   - 接続失敗時の動作テスト

### フェーズ3: コード品質の向上（優先度: 低）
1. **型ヒントの追加**
   - mypyでの型チェック通過を目指す
   - 戻り値の型注釈を明確化

2. **リファクタリング**
   - 重複コードの削減
   - メソッドの責務を明確化
   - 複雑度の高いメソッドの分割

3. **ドキュメント整備**
   - docstringの充実
   - 使用例の追加
   - APIドキュメントの生成

## 実施スケジュール
- フェーズ1: 即座に実施（1-2時間）
- フェーズ2: 2-3日以内
- フェーズ3: 1週間以内

## 成功指標
- テスト成功率: 100%
- コードカバレッジ: 80%以上
- mypy型チェック: エラー0件
- ruffリンティング: 違反0件

## リスクと対策
- **リスク**: 統合テストがDocker環境に依存
- **対策**: CI/CD環境でのテスト自動化を検討

## 次のステップ
1. ConnectionConfigの修正から着手
2. 統合テストのフィクスチャ修正
3. 単体テストの追加によるカバレッジ向上