# テスト修正とコード品質改善計画

## 現状分析

### テスト実行結果
- **全体**: 115テスト中
  - 成功: 78個 (67.8%)
  - 失敗: 18個 (15.7%)
  - エラー: 19個 (16.5%)

### 主な問題点

#### 1. データベース接続関連のエラー (19個)
統合テストでNeo4jとPostgreSQLへの接続が確立できていない:
- `test_connection.py`: 接続管理のテスト全て失敗
- `test_data_operations.py`: データ操作のテスト全て失敗  
- `test_transactions.py`: トランザクション関連のテスト全て失敗

**原因**: Docker環境が起動していない、または接続設定が不適切

#### 2. AST統合機能のテスト失敗 (5個)
- `test_ast_integration.py`: AST構造の格納・取得テストが失敗
- `test_ast_simple.py`: シンプルなAST格納テストが失敗

**原因**: `ConfigurationError`により設定が正しく読み込めていない

#### 3. Intent管理機能のテスト失敗 (6個)
- `test_intent_integration.py`: Intent-ASTマッピングのテストが失敗
- `test_manager.py`: IntentManagerのユニットテストの一部が失敗

**原因**: モック処理の不備やテストデータの問題

#### 4. メタデータ管理のテスト失敗 (5個)
- `test_index_manager.py`: インデックス分析機能のテスト失敗
- `test_stats_collector.py`: 統計収集機能のテスト失敗

**原因**: アサーションエラーやAttributeError

#### 5. トランザクション管理のテスト失敗 (2個)
- `test_manager.py`: ロールバック処理とタイムアウト処理のテスト失敗

**原因**: モックの動作が期待と異なる

## 改善計画

### フェーズ1: 環境整備 (優先度: 高)

#### 1.1 Docker環境の確認
```bash
# Docker環境の起動確認
docker-compose up -d

# 接続設定の環境変数確認
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USER="neo4j"
export NEO4J_PASSWORD="password"
export POSTGRES_HOST="localhost"
export POSTGRES_PORT="5432"
export POSTGRES_DB="graph_manager"
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="password"
```

#### 1.2 テスト用設定ファイルの作成
統合テスト用の設定を分離して、本番環境に影響を与えないようにする

### フェーズ2: テストコードの修正 (優先度: 高)

#### 2.1 AST統合テストの修正
- 設定読み込みの問題を解決
- テストデータの準備方法を改善

#### 2.2 Intent管理テストの修正
- モックオブジェクトの正しい設定
- テストデータの整合性確保

#### 2.3 メタデータ管理テストの修正
- アサーションエラーの原因特定と修正
- 期待値の見直し

#### 2.4 トランザクション管理テストの修正
- モックの動作を正しく設定
- タイムアウトテストの改善

### フェーズ3: コード品質の向上 (優先度: 中)

#### 3.1 型ヒントとドキュメントの充実
- すべての公開APIに型ヒントを追加
- docstringの追加・改善

#### 3.2 エラーハンドリングの改善
- より詳細なエラーメッセージ
- 適切な例外の使用

#### 3.3 パフォーマンスの最適化
- バッチ処理の効率化
- 接続プールの適切な管理

### フェーズ4: CI/CD環境の整備 (優先度: 低)

#### 4.1 GitHub Actionsの設定
- テスト自動実行
- コードカバレッジの計測
- 品質チェック（mypy、ruff）

#### 4.2 ドキュメントの整備
- APIドキュメントの自動生成
- 使用例の追加

## 実装順序

1. **即座に対応すべき項目**
   - Docker環境の起動と接続確認
   - 環境変数の設定
   - 単体テストの修正（モックの問題）

2. **短期的に対応すべき項目**
   - 統合テストの修正
   - エラーハンドリングの改善
   - 型ヒントの追加

3. **中長期的に対応すべき項目**
   - パフォーマンス最適化
   - CI/CD環境の構築
   - ドキュメントの充実

## 成功指標

- テスト成功率: 95%以上
- コードカバレッジ: 80%以上
- 型チェック（mypy）: エラー0
- リンター（ruff）: 警告0
- 統合テスト実行時間: 1分以内

## リスクと対策

### リスク1: データベース依存による開発効率の低下
**対策**: モックを活用した単体テストの充実

### リスク2: 既存機能への影響
**対策**: 段階的な修正とテストの実行

### リスク3: パフォーマンスの劣化
**対策**: ベンチマークテストの追加

## まとめ

現在のテスト失敗の多くは環境設定とモック処理の問題に起因しています。まずは環境を整備し、その後段階的にテストコードを修正していくことで、安定した品質を確保できます。