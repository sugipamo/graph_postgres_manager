# intent_store統合実装計画

## 概要
graph_postgres_managerライブラリにintent_store統合機能を実装し、Code-Smithプロジェクトのアーキテクチャを完成させる。

## 現状分析

### 実装済みの統合
- ✅ ast2graph統合: `store_ast_graph`メソッド実装済み
- ✅ code_intent_search統合: `search_unified`メソッド実装済み

### 未実装の統合
- ❌ intent_store統合: `link_intent_to_ast`メソッドが未実装
- ❌ IntentManagerクラスが部分的にしか実装されていない

## 実装タスク

### 1. データベーススキーマの設計と実装
- `intent_ast_map`テーブルの作成
  ```sql
  CREATE TABLE intent_ast_map (
      id SERIAL PRIMARY KEY,
      intent_id VARCHAR(255) NOT NULL,
      ast_node_id VARCHAR(255) NOT NULL,
      relationship_type VARCHAR(100) NOT NULL,
      confidence FLOAT DEFAULT 1.0,
      metadata JSONB,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(intent_id, ast_node_id, relationship_type)
  );
  ```

### 2. IntentManagerクラスの完成
- `link_intent_to_ast`メソッドの実装
- `get_intents_for_ast`メソッドの実装
- `get_asts_for_intent`メソッドの実装
- `update_intent_confidence`メソッドの実装
- バッチ処理対応

### 3. GraphPostgresManagerへの統合
- IntentManagerインスタンスの管理
- intent_store関連のAPIメソッド追加
- トランザクション管理の統合

### 4. テストの実装
- ユニットテスト
  - IntentManagerの各メソッドテスト
  - エラーハンドリングテスト
  - トランザクション整合性テスト
- 統合テスト
  - ast2graphとの連携テスト
  - code_intent_searchとの連携テスト
  - エンドツーエンドシナリオテスト

### 5. モック実装の追加
- MockIntentManagerクラスの実装
- テスト用のモックデータ生成

## 実装詳細

### link_intent_to_astメソッド
```python
async def link_intent_to_ast(
    self,
    intent_id: str,
    ast_node_id: str,
    relationship_type: str = "implements",
    confidence: float = 1.0,
    metadata: Optional[Dict[str, Any]] = None
) -> bool:
    """
    意図とASTノードをリンクする
    
    Args:
        intent_id: 意図のID
        ast_node_id: ASTノードのID
        relationship_type: 関係性のタイプ（implements, references, etc.）
        confidence: 信頼度スコア（0.0-1.0）
        metadata: 追加のメタデータ
    
    Returns:
        成功した場合True
    """
```

### 統合アーキテクチャ
```
ast2graph → Neo4j (AST構造)
    ↓
graph_postgres_manager (統合管理)
    ↓
intent_store → PostgreSQL (意図データ)
    ↓
code_intent_search (統合検索)
```

## 成功基準
1. link_intent_to_astメソッドが正常に動作すること
2. 既存のast2graph、code_intent_search統合との整合性が保たれること
3. トランザクション管理が適切に機能すること
4. テストカバレッジが80%以上を維持すること
5. パフォーマンスが既存機能と同等以上であること

## スケジュール
- Day 1-2: データベーススキーマ設計とIntentManager実装
- Day 3: GraphPostgresManagerへの統合
- Day 4-5: テスト実装とデバッグ
- Day 6: ドキュメント作成と最終確認

## リスクと対策
1. **スキーマ競合**: 既存のテーブルとの競合
   - 対策: 名前空間の分離、マイグレーション戦略の策定
2. **パフォーマンス劣化**: 大量データ処理時の遅延
   - 対策: インデックス最適化、バッチ処理の実装
3. **トランザクション複雑化**: 3つのシステム間での整合性
   - 対策: 段階的コミット、ロールバック戦略の明確化