# コード品質改善と依存関係解決計画

## 概要
graph_postgres_managerプロジェクトのコード品質チェックを実施した結果、以下の問題が発見されました。

## 発見された問題

### 1. テスト実行環境の問題
- 依存関係のインストールに仮想環境が必要
- 統合テストがデータベース接続を必要とするため、19件のエラーが発生
- 7件のユニットテストが失敗

### 2. コード品質の問題（Ruffによる検証結果）
- **772件のエラー**が検出されました
- 540件は自動修正可能
- 主な問題カテゴリ：
  - インポートの整理不備
  - 非推奨のタイプヒント使用（Tuple → tuple, List → list など）
  - 文字列リテラルの例外メッセージ
  - ロギングでのf-string使用
  - 行長制限（100文字）の超過
  - シングルクォートの使用（ダブルクォート推奨）
  - 未使用のインポート

## 改善計画

### フェーズ1: コード品質の自動修正（優先度：高）
1. Ruffの自動修正機能を使用して540件の問題を修正
   ```bash
   python3 -m ruff check src/ --fix
   ```

2. 手動で修正が必要な主要項目：
   - 例外メッセージの変数化
   - ロギングステートメントの改善
   - 行長制限の対応

### フェーズ2: タイプヒントの現代化（優先度：中）
- `typing.Tuple` → `tuple`
- `typing.List` → `list`
- `typing.Dict` → `dict`
- `typing.Optional[X]` → `X | None`

### フェーズ3: テスト環境の整備（優先度：高）
1. Docker環境でのテスト実行環境構築
2. 統合テスト用のデータベース接続設定
3. モックを使用したユニットテストの改善

### フェーズ4: 失敗しているテストの修正（優先度：高）
失敗しているテスト：
- `test_analyze_index_usage`
- `test_find_duplicate_indexes`
- `test_suggest_indexes`
- `test_generate_recommendations`
- `test_extract_table_references`
- `test_rollback_failure_handling`
- `test_transaction_timeout`

## 推奨される実行順序
1. Ruffによる自動修正の実行
2. 手動修正が必要な項目の対応
3. テスト環境の整備（Docker環境の活用）
4. 失敗しているテストの修正

## 期待される成果
- コードの保守性向上
- Python 3.12の新機能への対応
- テストカバレッジの向上
- CI/CDパイプラインでの品質チェック自動化

## 次のステップ
1. Ruff自動修正の実行と確認
2. 手動修正項目のリストアップと実装
3. テスト環境の構築計画策定