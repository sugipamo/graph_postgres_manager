# コード品質改善Phase1-4実施計画

## 概要
graph_postgres_managerプロジェクトのコード品質を改善し、テストカバレッジを向上させる。現在379件のLintエラー、3件の失敗テスト、多数の型エラーが存在する状況を改善する。

## 現状分析

### テスト状況
- **総テスト数**: 173件
- **失敗**: 3件
- **エラー**: 35件（主にDocker環境未構築）
- **成功率**: 78.0%

### Lintエラー内訳（379件）
- **自動修正可能**: 229件（60.4%）
  - 未使用インポート（F401）: 多数
  - インポート順序（I001）: 多数
  - クォート統一（Q000）: 多数
- **手動修正必要**: 150件（39.6%）
  - 未使用変数（F841）
  - 行長超過（E501）
  - セキュリティ警告（S110, S607）

### 型チェックエラー
- 型注釈の不整合
- Noneチェックの欠如
- 引数の型不一致

## 実施計画

### Phase 1: 自動修正の実行（30分）
**目標**: 229件のLintエラーを自動修正

1. **ruff自動修正の実行**
   ```bash
   ruff check . --fix
   ```

2. **修正内容の確認**
   - gitで変更内容を確認
   - 意図しない変更がないかチェック

3. **テスト実行**
   ```bash
   make test-unit
   ```

### Phase 2: ユニットテスト修正（1時間）
**目標**: 3件の失敗テストを修正

1. **test_config.py::TestConnectionConfig::test_default_config**
   - 問題: デフォルト値の検証エラー
   - 対策: 環境変数のモック化または期待値の修正

2. **test_search_manager.py::TestSearchManager::test_text_search**
   - 問題: モックオブジェクトの設定不備
   - 対策: 適切なモック設定の実装

3. **test_search_manager.py::TestSearchManager::test_unified_search**
   - 問題: 非同期処理のエラー
   - 対策: 非同期モックの適切な設定

### Phase 3: 手動Lintエラー修正（2時間）
**目標**: 150件の手動修正が必要なエラーを解消

1. **優先順位付け**
   - セキュリティ警告（S110, S607）: 最優先
   - 未使用変数（F841）: 高
   - 行長超過（E501）: 中

2. **セクション別修正**
   - src/graph_postgres_manager/core/
   - src/graph_postgres_manager/adapters/
   - src/graph_postgres_manager/metadata/
   - src/graph_postgres_manager/intent/
   - src/graph_postgres_manager/search/

3. **修正方針**
   - セキュリティ: 適切な例外処理とバリデーション追加
   - 未使用変数: 削除または`_`プレフィックス付与
   - 行長: 適切な位置での改行

### Phase 4: 型チェックエラー修正（2時間）
**目標**: mypyエラーをゼロに

1. **型注釈の追加・修正**
   - 関数の引数と戻り値
   - クラスのアトリビュート
   - ジェネリック型の適切な使用

2. **Noneチェックの追加**
   - Optional型の適切な処理
   - アサーションまたは早期リターン

3. **型の整合性確保**
   - インターフェースの統一
   - 型変換の明示化

## 検証手順

### 各Phase完了後の確認
1. **Lintチェック**
   ```bash
   make lint
   ```

2. **型チェック**
   ```bash
   make type-check
   ```

3. **テスト実行**
   ```bash
   make test-unit
   ```

### 最終確認
1. **全体テスト**
   ```bash
   make test
   ```

2. **カバレッジ確認**
   ```bash
   make test-coverage
   ```

## 成功指標
- Lintエラー: 0件
- 型チェックエラー: 0件
- ユニットテスト成功率: 100%（Docker依存を除く）
- コードカバレッジ: 80%以上維持

## リスクと対策

### リスク
1. 自動修正による意図しない変更
2. テスト修正による仕様変更
3. 型注釈追加によるパフォーマンス劣化

### 対策
1. 各Phase後のgit diff確認
2. テスト仕様の文書化
3. パフォーマンステストの実行

## タイムライン
- **開始**: 2025-07-04 05:07
- **Phase 1完了予定**: 05:37
- **Phase 2完了予定**: 06:37
- **Phase 3完了予定**: 08:37
- **Phase 4完了予定**: 10:37
- **最終確認完了予定**: 11:00

## 次のステップ
1. Docker環境修復（35件のエラー解消）
2. CI/CDパイプラインの修正
3. ドキュメントの更新

## 備考
- 本計画は202507040401_計画_コード品質改善.mdの詳細実施計画
- Docker関連のエラーは別途対応予定
- 修正内容は適宜コミット（機能単位）