# コード品質改善計画

## 現状分析

### 1. テスト結果
- **pytest実行結果**: 173テスト中、3つ失敗、35エラー
  - 統合テストエラー: Docker環境未構築によるもの
  - ユニットテスト失敗:
    - `test_config.py::TestConnectionConfig::test_default_config`
    - `test_search_manager.py::TestSearchManager::test_text_search`
    - `test_search_manager.py::TestSearchManager::test_unified_search`

### 2. Lint結果（ruff）
- **379個のエラー**（229個は自動修正可能）
- 主な問題:
  - 未使用のインポート（F401）
  - 未使用の変数（F841）
  - 行の長さ超過（E501）
  - インポート順序（I001）
  - クォート統一（Q000）
  - セキュリティ問題（S110, S607）

### 3. 型チェック結果（mypy）
- 多数の型エラー
- 主な問題:
  - 型注釈の不整合
  - Noneチェックの欠如
  - 引数の型不一致

## 改善計画

### Phase 1: 自動修正可能な問題の解決（即時実行）
1. ruffの自動修正を実行
   ```bash
   ruff check . --fix
   ```

### Phase 2: ユニットテストの修正（優先度：高）
1. `test_config.py`の修正
   - デフォルト設定の検証ロジック修正
   
2. `test_search_manager.py`の修正
   - モックオブジェクトの設定修正
   - 非同期処理の適切な処理

### Phase 3: 手動修正が必要なLintエラー（優先度：中）
1. セキュリティ関連の警告対応
2. 長すぎる行の分割
3. 未使用変数の削除

### Phase 4: 型エラーの修正（優先度：高）
1. 型注釈の追加・修正
2. Noneチェックの追加
3. 引数の型整合性確保

### Phase 5: 統合テスト環境の整備（優先度：低）
1. Docker環境の構築
2. テスト用データベースの設定

## 実行手順

### 1. 自動修正の実行
```bash
# Lintの自動修正
ruff check . --fix

# インポート順序の自動修正
ruff check . --select I --fix
```

### 2. 重要なテストエラーの修正
- `test_config.py`のアサーション修正
- `test_search_manager.py`のモック設定修正

### 3. 型エラーの段階的修正
- 最も重要なモジュールから順次修正
- `manager.py`、`connections/`配下を優先

## 期待される成果

1. **テスト成功率**: 95%以上（統合テストを除く）
2. **Lintエラー**: 50個以下
3. **型エラー**: 0個
4. **コード品質スコア**: 8/10以上

## リスクと対策

1. **大規模な修正による新たなバグ**
   - 段階的な修正とテストの実行
   - 各修正後のテスト実行

2. **互換性の問題**
   - APIの変更は最小限に
   - 既存の動作を維持

## タイムライン

- Phase 1: 即時（10分）
- Phase 2: 30分
- Phase 3: 1時間
- Phase 4: 2時間
- Phase 5: 別途計画

## 成功指標

1. すべてのユニットテストが成功
2. Lintエラーが管理可能な範囲内
3. 型チェックがクリーン
4. コードの可読性向上