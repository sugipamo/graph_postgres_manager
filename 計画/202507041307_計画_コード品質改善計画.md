# コード品質改善計画

作成日: 2025-07-04 13:07
プロジェクト: graph_postgres_manager

## 1. 現状分析

### 1.1 プロジェクト概要
- **責務**: Neo4jとPostgreSQLの統合管理を行い、グラフデータとリレーショナルデータの一貫性を保証するデータ管理ライブラリ
- **親プロジェクト**: Code-Smithプロジェクトの一部として、AST構造と意図（Intent）を対応付けるシステムのデータ管理レイヤー

### 1.2 テスト実行結果
- **ユニットテスト**: 117テスト全て成功 ✓
- **統合テスト**: 35テストがエラー（主にフィクスチャ関連）
- **総テスト数**: 173テスト（138 passed, 35 errors）

### 1.3 コード品質チェック結果

#### Ruffチェック（7エラー）
1. `exceptions.py:9`: N818 - `ConnectionException`は`Error`サフィックスを付けるべき
2. `mocks/data_store.py:454`: PLC0415 - importはファイルのトップレベルに配置すべき
3. `mocks/manager.py:54,55`: A002 - 引数名`id`, `type`がPythonビルトインをシャドウイング
4. `mocks/manager.py:187`: G004 - ログ文でf-stringを使用
5. `mocks/manager.py:662,691`: SIM102 - ネストしたif文を単一のif文に結合すべき

#### MyPyチェック（多数のエラー）
- 型アノテーション不足
- 辞書アクセスでのNone値チェック不足
- 引数の型不一致（特にPostgreSQLのexecuteメソッド）
- Optionalな値の適切な処理不足

## 2. 優先度別改善計画

### 2.1 高優先度（即座に修正）

#### 2.1.1 統合テストのフィクスチャ問題
**問題**: `_event_loop`フィクスチャが見つからない
**原因**: pytest-asyncioのバージョン互換性の問題
**対策**:
- conftest.pyのフィクスチャ定義を修正
- pytest-asyncioの設定を見直し

#### 2.1.2 例外命名規則
**問題**: `ConnectionException`がPEP8の例外命名規則に違反
**対策**: `ConnectionError`に名前変更（影響範囲の確認必要）

### 2.2 中優先度（段階的修正）

#### 2.2.1 型アノテーション改善
**対象**:
- PostgreSQL接続のexecuteメソッドパラメータ
- 辞書アクセス時のNone値チェック
- データストアの戻り値型

**対策**:
- 型ヒントの追加と修正
- Optional型の適切な使用
- 型ガードの実装

#### 2.2.2 コードスタイル改善
**対象**:
- ビルトイン名のシャドウイング（id, type）
- ネストしたif文の簡素化
- import文の配置

**対策**:
- パラメータ名の変更（id → node_id, type → node_type）
- 条件文の最適化
- import文の整理

### 2.3 低優先度（将来的改善）

#### 2.3.1 ログ出力の最適化
**問題**: f-stringの使用がログレベルに関わらず評価される
**対策**: 遅延評価を使用したログ出力に変更

#### 2.3.2 テストカバレッジの向上
**現状**: pytest-covが未インストール
**対策**: カバレッジツールの導入と測定

## 3. 実装スケジュール

### Phase 1: 即座対応（1日）
1. [ ] 統合テストのフィクスチャ修正
2. [ ] ConnectionException → ConnectionErrorへの名前変更
3. [ ] ビルトイン名シャドウイングの修正

### Phase 2: 型安全性向上（2-3日）
1. [ ] PostgreSQL executeメソッドの型修正
2. [ ] 辞書アクセスのNone値チェック追加
3. [ ] 戻り値型の明確化

### Phase 3: コード品質向上（1-2日）
1. [ ] import文の整理
2. [ ] 条件文の最適化
3. [ ] ログ出力の改善

### Phase 4: テスト環境整備（1日）
1. [ ] pytest-covの設定
2. [ ] カバレッジレポートの生成
3. [ ] CI/CDパイプラインへの統合

## 4. 成功指標

- **テスト**: 全173テストが成功
- **Ruff**: エラー0件
- **MyPy**: エラー数を現在の50%以下に削減
- **カバレッジ**: 80%以上のコードカバレッジ達成

## 5. リスクと対策

### 5.1 破壊的変更のリスク
- **リスク**: ConnectionException → ConnectionErrorの変更が既存コードに影響
- **対策**: 
  - 影響範囲の事前調査
  - 段階的な移行（エイリアスの一時的提供）

### 5.2 型修正による互換性問題
- **リスク**: 厳密な型チェックにより既存の動作が変わる可能性
- **対策**:
  - 段階的な型追加
  - 実行時の動作確認テスト

## 6. 備考

- 親プロジェクトのCode-Smithとの整合性を保ちながら改善を実施
- ライブラリの再利用性を損なわないよう注意
- 各フェーズ完了時に進捗を記録