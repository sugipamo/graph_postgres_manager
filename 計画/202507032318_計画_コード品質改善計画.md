# コード品質改善計画

## 実施日時
2025-07-03 23:18

## 現状の分析結果

### 1. テスト結果
- **総テスト数**: 173
- **成功**: 167
- **失敗**: 6
- **成功率**: 96.5%

### 2. 失敗しているテスト
1. `test_intent_with_unified_search` - PostgreSQL接続エラー（`AsyncConnection`の属性エラー）
2. `test_default_config` - デフォルト設定の不一致
3. `test_link_intent_to_ast_basic` - タプルインデックスエラー
4. `test_link_intent_to_ast_with_vector` - タプルインデックスエラー
5. `test_get_ast_nodes_by_intent` - タプルインデックスエラー
6. `test_search_ast_by_intent_vector` - タプルインデックスエラー

### 3. 型チェック（mypy）結果
- **エラー数**: 約40件
主な問題：
- 型アノテーションの不一致
- None型のハンドリング不足
- dictアクセスの型安全性
- PostgreSQL接続のパラメータ型不一致

### 4. リンティング（ruff）結果
- **エラー数**: 246件
主な問題：
- 未使用のインポート
- 古い型アノテーション（`Dict`→`dict`など）
- 相対インポートの使用
- 命名規則違反（Exception名）
- コード行の長さ超過

## 改善計画

### Phase 1: 緊急修正（優先度：高）

#### 1.1 PostgreSQL接続エラーの修正
**問題**: `AsyncConnection`オブジェクトの`fetch`属性エラー
**原因**: psycopgの非同期APIの誤用
**修正内容**:
- `postgres.py`の`execute`メソッドで正しい非同期メソッドを使用
- `fetchall()`→`fetch()`の修正

#### 1.2 タプルインデックスエラーの修正
**問題**: PostgreSQL結果セットの誤った処理
**原因**: 辞書形式でのアクセスを期待しているが、タプルが返されている
**修正内容**:
- `intent/manager.py`での結果処理を修正
- タプルからの値取得方法を修正

### Phase 2: 型安全性の改善（優先度：中）

#### 2.1 型アノテーションの修正
- 古い型アノテーション（`Dict`, `List`, `Tuple`）を新しい形式に変更
- `Optional[X]`を`X | None`に変更
- 欠落している型アノテーションの追加

#### 2.2 None型ハンドリングの改善
- 接続オブジェクトのNoneチェック追加
- 適切なエラーハンドリング

### Phase 3: コード品質の改善（優先度：低〜中）

#### 3.1 未使用インポートの削除
- ruffで検出された未使用インポートを削除

#### 3.2 命名規則の修正
- `GraphPostgresManagerException`→`GraphPostgresManagerError`

#### 3.3 相対インポートの修正
- 相対インポートを絶対インポートに変更

### Phase 4: テスト環境の改善

#### 4.1 設定の修正
- デフォルト設定値の調整
- 環境変数による設定オーバーライドの確認

#### 4.2 統合テストの安定化
- データベース接続の初期化処理の改善
- テストデータのクリーンアップ

## 実装優先順位

1. **即座に修正すべき項目**（30分以内）
   - PostgreSQL接続エラー
   - タプルインデックスエラー
   - デフォルト設定値

2. **短期的に修正すべき項目**（1時間以内）
   - 型アノテーションの更新
   - 未使用インポートの削除
   - 命名規則の修正

3. **中期的に改善すべき項目**（2時間以内）
   - None型ハンドリングの強化
   - エラーハンドリングの改善
   - テストの安定化

## 成功指標

- すべてのテストが成功する（100%）
- mypy エラーが0件になる
- ruff エラーが大幅に削減される（80%以上削減）
- CI/CDパイプラインが正常に動作する

## リスクと対策

### リスク
1. 修正により新たなバグが発生する可能性
2. 既存の動作に影響を与える可能性

### 対策
1. 修正は小さな単位で行い、都度テストを実行
2. 重要な変更には詳細なコメントを追加
3. バックアップとロールバック計画の準備