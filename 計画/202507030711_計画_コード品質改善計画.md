# コード品質改善計画

## 実行日時
2025-07-03 07:11

## 現状分析

### 1. テスト実行結果
- **テスト総数**: 104
- **成功**: 73 (70.2%)
- **失敗**: 12 (11.5%)
- **エラー**: 19 (18.3%)
- **警告**: 142

### 2. 主な問題点

#### 2.1 統合テストの問題
- Docker環境への依存による統合テストの失敗
- `wait_for_services`の非同期処理に関する問題
- Neo4j/PostgreSQL接続エラー

#### 2.2 コード品質の問題（Ruff検出）
- **230件のエラー検出**
- 主な問題カテゴリ：
  - `EM101/EM102`: 例外メッセージの文字列リテラル使用（85件）
  - `E501`: 行長制限（100文字）超過（40件）
  - `TID252`: 相対インポートの使用（15件）
  - `G004`: f-string形式のログメッセージ（25件）
  - `A004`: Python組み込み名のシャドーイング（1件）
  - その他のコード規約違反

#### 2.3 型チェックの状況
- mypyが環境にインストールされていないため未実施
- 型アノテーションの一貫性が未検証

## 改善計画

### Phase 1: 緊急対応（優先度：高）

#### 1.1 Python組み込み名のシャドーイング修正
```python
# 現在: TimeoutError（組み込み名と衝突）
# 修正: DBTimeoutError または GraphTimeoutError
```

#### 1.2 例外メッセージの変数化
```python
# 現在
raise ConfigurationError("connection_pool_size must be at least 1")

# 修正後
POOL_SIZE_ERROR = "connection_pool_size must be at least 1"
raise ConfigurationError(POOL_SIZE_ERROR)
```

#### 1.3 統合テストの環境依存問題
- Docker環境チェックの追加
- テストスキップ条件の実装
- モックを使用した単体テストへの分離

### Phase 2: コード品質改善（優先度：中）

#### 2.1 行長制限の対応
- 100文字を超える行の分割
- 特に型アノテーションと関数シグネチャの整形

#### 2.2 インポート構造の改善
- 相対インポートから絶対インポートへの変更
- インポート順序の統一（標準ライブラリ→サードパーティ→ローカル）

#### 2.3 ログメッセージの改善
```python
# 現在
logger.error(f"Failed to rollback transaction {transaction_id}: {rollback_error}")

# 修正後
logger.error("Failed to rollback transaction %s: %s", transaction_id, rollback_error)
```

### Phase 3: テスト環境の改善（優先度：中）

#### 3.1 非同期処理の改善
- `wait_for_services`の適切な await 処理
- pytest-asyncio の設定最適化
- イベントループ管理の改善

#### 3.2 環境分離の実装
```python
@pytest.mark.integration
@pytest.mark.skipif(
    not os.environ.get("INTEGRATION_TEST"),
    reason="Integration tests require INTEGRATION_TEST=1"
)
```

### Phase 4: 長期的改善（優先度：低）

#### 4.1 設計哲学との整合性
- 進化メタファーに基づく命名規則の適用
- エラーメッセージの生物学的表現への変更

#### 4.2 パフォーマンス最適化
- バッチ処理の効率化
- 接続プール管理の最適化

## 実装優先順位

1. **即時対応（1日以内）**
   - Python組み込み名のシャドーイング修正
   - 統合テストのスキップ条件追加
   - 重要な例外メッセージの変数化

2. **短期対応（3日以内）**
   - Ruffエラーの段階的修正
   - 非同期処理の警告対応
   - 基本的なコード規約違反の修正

3. **中期対応（1週間以内）**
   - テスト環境の完全分離
   - 型チェックの導入
   - ドキュメントの更新

## 成功指標

- Ruffエラー数: 230 → 0
- テスト成功率: 70.2% → 95%以上
- 警告数: 142 → 10以下
- 統合テストの環境非依存実行

## リスクと対策

### リスク
1. 大規模なリファクタリングによる既存機能への影響
2. テスト環境分離による統合テストカバレッジの低下

### 対策
1. 段階的な修正とテスト実行の反復
2. モックとスタブを活用した単体テストの充実
3. CI/CDパイプラインでの統合テスト環境構築

## 次のアクション

1. この計画の承認を得る
2. Phase 1の実装開始
3. 進捗の定期報告（毎日）