# モック実装計画 - graph_postgres_manager

**作成日**: 2025-07-03 23:00  
**対象**: graph_postgres_manager モック機能実装  
**目的**: 他プロジェクトでの利用を容易にするためのモック実装

## プロジェクト概要

graph_postgres_managerライブラリを使用する他プロジェクトが、実際のNeo4jやPostgreSQLサーバーなしでテストを実行できるようにするモック実装を提供します。

## 実装スコープ

### Phase 1: 基本モック実装（2日間）

#### 1.1 ディレクトリ構造の作成
```
src/graph_postgres_manager/
├── mocks/
│   ├── __init__.py           # モック公開API
│   ├── manager.py            # MockGraphPostgresManager
│   ├── connections.py        # MockConnections
│   ├── transactions.py       # MockTransactionManager
│   └── data_store.py         # インメモリデータストア
```

#### 1.2 MockGraphPostgresManager の実装
**目的**: GraphPostgresManagerの完全な代替品を提供

**主要機能**:
- 実際のAPIと同じインターフェース
- インメモリでの状態管理
- 設定可能なレスポンス
- エラーシミュレーション機能

**実装予定メソッド**:
```python
class MockGraphPostgresManager:
    # 基本操作
    async def initialize()
    async def close()
    async def health_check()
    
    # クエリ実行
    async def execute_neo4j_query()
    async def execute_postgres_query()
    
    # バッチ操作
    async def batch_insert_neo4j()
    async def batch_insert_postgres()
    
    # トランザクション
    def transaction()
    
    # 検索機能
    async def search_unified()
    
    # AST管理
    async def store_ast_graph()
```

#### 1.3 MockConnections の実装
**目的**: Neo4j/PostgreSQL接続のモック

**Neo4jモック機能**:
- Cypherクエリの実行シミュレーション
- ノード/リレーションシップの管理
- インデックス操作
- バッチインサート

**PostgreSQLモック機能**:
- SQL実行シミュレーション
- テーブル操作
- トランザクション管理
- メタデータ管理

#### 1.4 MockTransactionManager の実装
**目的**: トランザクション処理のモック

**機能**:
- 分散トランザクションのシミュレーション
- コミット/ロールバック
- 2フェーズコミット
- タイムアウト処理

### Phase 2: データストアと状態管理（1日間）

#### 2.1 InMemoryDataStore の実装
**目的**: モック内でのデータ永続化

**機能**:
- グラフデータの保存（ノード/エッジ）
- リレーショナルデータの保存（テーブル/レコード）
- インデックス管理
- クエリ実行エンジン（簡易版）

**データ構造**:
```python
class InMemoryDataStore:
    nodes: Dict[str, Dict]           # Neo4jノード
    relationships: List[Dict]        # Neo4jリレーションシップ
    tables: Dict[str, List[Dict]]    # PostgreSQLテーブル
    indexes: Dict[str, Dict]         # インデックス情報
    transaction_state: Dict          # トランザクション状態
```

#### 2.2 クエリシミュレーション
- **Cypher風のクエリ処理**（基本的なMATCH/CREATE/DELETE）
- **SQL風のクエリ処理**（基本的なSELECT/INSERT/UPDATE/DELETE）
- **結果セットの生成**

### Phase 3: テスト支援機能（1日間）

#### 3.1 設定可能な動作
```python
mock_manager = MockGraphPostgresManager()
mock_manager.configure({
    'neo4j_latency': 100,           # レスポンス遅延(ms)
    'postgres_latency': 50,
    'error_rate': 0.1,              # エラー発生率
    'max_connections': 10,
    'timeout_simulation': True
})
```

#### 3.2 エラーシミュレーション
- 接続エラー
- タイムアウトエラー
- リソース不足エラー
- データ不整合エラー

#### 3.3 アサーション支援
```python
# テストでの使用例
mock_manager.assert_query_called('CREATE (n:Node)')
mock_manager.assert_transaction_committed()
mock_manager.get_call_history()
```

### Phase 4: ドキュメント・サンプル（半日）

#### 4.1 使用例の作成
```python
# 基本的な使用例
from graph_postgres_manager.mocks import MockGraphPostgresManager

async def test_my_feature():
    mock_manager = MockGraphPostgresManager()
    await mock_manager.initialize()
    
    # テストコード
    result = await mock_manager.execute_neo4j_query(
        "MATCH (n) RETURN n"
    )
    
    await mock_manager.close()
```

#### 4.2 設定例の提供
- 典型的なテストシナリオ
- エラーケースのテスト
- パフォーマンステスト用設定

## 技術仕様

### 依存関係
- **新規依存なし**: 標準ライブラリのみ使用
- **Optional**: typing_extensions（型ヒント強化）

### パフォーマンス要件
- **メモリ使用量**: 実データの1/10以下
- **レスポンス時間**: 実装の1/100以下
- **初期化時間**: 1秒以内

### 互換性
- **API互換**: 100%（実装と同じインターフェース）
- **Python**: 3.12+
- **async/await**: 完全対応

## 実装スケジュール

### Day 1: 基盤実装
- [ ] ディレクトリ構造作成
- [ ] MockGraphPostgresManager骨格
- [ ] 基本的なConnection mock
- [ ] シンプルなテストケース

### Day 2: 機能実装
- [ ] クエリ実行モック
- [ ] トランザクション管理
- [ ] データストア実装
- [ ] エラーハンドリング

### Day 3: 高度な機能
- [ ] 検索機能モック
- [ ] AST管理モック
- [ ] 設定可能な動作
- [ ] テスト支援機能

### Day 4: 仕上げ
- [ ] ドキュメント作成
- [ ] サンプルコード
- [ ] テストの完成
- [ ] 既存テストとの統合

## 成功指標

### 機能性
- [ ] 全APIメソッドのモック実装完了
- [ ] 既存のユニットテストがモックでも動作
- [ ] エラーケースの正しいシミュレーション

### 使いやすさ
- [ ] 1行でモック有効化可能
- [ ] 設定なしでも基本動作
- [ ] 明確なドキュメント

### パフォーマンス
- [ ] 実装の10倍以上高速
- [ ] メモリ使用量最小化
- [ ] 初期化時間1秒以内

## リスク管理

### 技術リスク
- **複雑なクエリ処理**: 簡易版で対応、必要に応じて拡張
- **トランザクション状態管理**: 状態マシンで管理
- **メモリ使用量**: 弱参照とガベージコレクション活用

### 保守性リスク
- **API変更の同期**: 自動テストで検出
- **機能差異**: 明確なドキュメント化
- **バグの混入**: 既存テストでの検証

## 追加検討事項

### 将来の拡張
- より高度なクエリ処理
- ファイルベースの永続化
- パフォーマンス測定機能
- ビジュアル化ツール

### 他プロジェクトとの連携
- ast2graphのモック対応
- intent_storeのモック対応
- code_intent_searchのテスト支援

## 品質保証

### テスト戦略
- [ ] モック自体のユニットテスト
- [ ] 実装との動作比較テスト
- [ ] 統合テストでのモック使用
- [ ] エラーケースの検証

### コード品質
- [ ] 型ヒント100%
- [ ] docstring完備
- [ ] Ruffチェック通過
- [ ] カバレッジ90%以上

この計画に基づいて、他プロジェクトでの利用を容易にする高品質なモック実装を提供します。