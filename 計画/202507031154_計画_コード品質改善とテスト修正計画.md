# コード品質改善とテスト修正計画

## 作成日時
2025-07-03 11:54

## 背景と目的
graph_postgres_managerプロジェクトのコード品質チェックを実施した結果、以下の問題が検出されました：
- pytest実行時：18失敗、78成功、90警告、19エラー
- ruff実行時：255個のコード品質エラー

これらの問題を体系的に解決し、コード品質の向上とテストの安定化を図る必要があります。

## 検出された主要な問題

### 1. テスト関連の問題（pytest結果より）
#### 失敗しているテスト（18件）
- AST統合テスト（4件）
- Intent統合テスト（4件）
- IntentManagerユニットテスト（2件）
- IndexManagerユニットテスト（4件）
- StatsCollectorユニットテスト（1件）
- TransactionManagerユニットテスト（2件）
- その他（1件）

#### エラーが発生しているテスト（19件）
- 接続管理テスト（6件）
- データ操作テスト（6件）
- トランザクション統合テスト（7件）

#### 主な原因
- Docker環境（Neo4j、PostgreSQL）への接続エラー
- モックオブジェクトの設定不備
- 非同期処理のリソース管理問題

### 2. コード品質の問題（ruff結果より）
#### 主要なエラータイプ
1. **インポート関連（101件）**
   - TID252: 相対インポートの使用（絶対インポートが推奨）
   - A004: Python組み込み名のシャドウイング（TimeoutError）

2. **例外処理（52件）**
   - EM101: 例外メッセージの文字列リテラル直接使用
   - EM102: f-string例外メッセージの直接使用

3. **ロギング（32件）**
   - G003/G004: ロギングでのf-string使用

4. **コード行長（30件）**
   - E501: 100文字を超える行

5. **未使用インポート（40件）**
   - F401: インポートされたが使用されていないモジュール

## 改善計画

### Phase 1: 緊急対応（1日）
1. **Docker環境の確認と修正**
   - docker-compose.ymlの検証
   - テスト用データベースの初期化スクリプト確認
   - 接続設定の見直し

2. **クリティカルなエラーの修正**
   - Python組み込み名のシャドウイング（TimeoutError → TimeoutException）
   - 相対インポートを絶対インポートに変更

### Phase 2: テスト安定化（2日）
1. **統合テストの修正**
   - Docker環境チェックの追加
   - テストのスキップ条件設定
   - モックを使用したユニットテストへの切り替え検討

2. **非同期処理の改善**
   - リソースの適切なクリーンアップ
   - 非同期コンテキストマネージャーの修正

3. **テストフィクスチャの整備**
   - 共通のセットアップ/ティアダウン処理の統一
   - フィクスチャのスコープ最適化

### Phase 3: コード品質向上（2日）
1. **例外処理の改善**
   - 例外メッセージを定数化
   - カスタム例外クラスの充実

2. **ロギングの標準化**
   - f-stringの代わりに%スタイルまたは.format()使用
   - 構造化ログの導入

3. **コードフォーマット**
   - 行長の調整
   - 未使用インポートの削除

### Phase 4: 継続的品質管理（1日）
1. **CI/CDパイプラインの強化**
   - pre-commitフックの設定
   - GitHub Actionsでの自動チェック

2. **開発者ガイドラインの作成**
   - コーディング規約ドキュメント
   - テスト作成ガイド

## 実装優先順位

### 最優先（即時対応）
1. TimeoutErrorのシャドウイング修正
2. Docker環境の動作確認
3. 統合テストのスキップ条件追加

### 高優先度（1-2日以内）
1. 相対インポートの修正
2. 非同期リソース管理の改善
3. 例外メッセージの定数化

### 中優先度（3-5日以内）
1. ロギングの標準化
2. 行長の調整
3. 未使用インポートの削除

## 成功基準
1. **テスト成功率**: 95%以上（統合テストは環境依存を考慮）
2. **ruffエラー数**: 50件以下
3. **テストカバレッジ**: 80%以上維持
4. **CI/CD**: 全チェックがグリーン

## リスクと対策
1. **統合テストの環境依存**
   - 対策: Dockerコンテナの健全性チェック追加
   - 対策: テストのカテゴリ分けとスキップ機能

2. **大規模リファクタリングによる不具合**
   - 対策: 段階的な修正とテスト実行
   - 対策: gitでの細かいコミット

3. **開発速度の低下**
   - 対策: 自動修正ツールの活用
   - 対策: チーム内での作業分担

## 次のアクション
1. TimeoutErrorシャドウイング問題の即時修正
2. Docker環境の動作確認とドキュメント化
3. 統合テストのスキップ条件実装
4. ruff --fix での自動修正可能な項目の一括修正

## 備考
- 現在の実装は機能的には完成度が高く、品質改善により安定性が大幅に向上する見込み
- code_intent_search統合実装と並行して進めることも可能だが、基盤の安定化を優先すべき