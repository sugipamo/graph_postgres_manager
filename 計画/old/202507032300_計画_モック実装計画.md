# モック実装計画 - graph_postgres_manager

**作成日**: 2025-07-03 23:00  
**対象**: graph_postgres_manager モック機能実装  
**目的**: 他プロジェクトでの利用を容易にするためのモック実装

## プロジェクト概要

graph_postgres_managerライブラリを使用する他プロジェクトが、実際のNeo4jやPostgreSQLサーバーなしでテストを実行できるようにするモック実装を提供します。

## 実装スコープ

### Phase 1: 基本モック実装（2日間）

#### 1.1 ディレクトリ構造の作成
```
src/graph_postgres_manager/
├── mocks/
│   ├── __init__.py           # モック公開API
│   ├── manager.py            # MockGraphPostgresManager
│   ├── connections.py        # MockConnections
│   ├── transactions.py       # MockTransactionManager
│   └── data_store.py         # インメモリデータストア
```

#### 1.2 MockGraphPostgresManager の実装
**目的**: GraphPostgresManagerの完全な代替品を提供

**主要機能**:
- 実際のAPIと同じインターフェース
- インメモリでの状態管理
- 設定可能なレスポンス
- エラーシミュレーション機能

**実装予定メソッド**:
```python
class MockGraphPostgresManager:
    # 基本操作
    async def initialize()
    async def close()
    async def health_check()
    
    # クエリ実行
    async def execute_neo4j_query()
    async def execute_postgres_query()
    
    # バッチ操作
    async def batch_insert_neo4j()
    async def batch_insert_postgres()
    
    # トランザクション
    def transaction()
    
    # 検索機能
    async def search_unified()
    
    # AST管理
    async def store_ast_graph()
```

#### 1.3 MockConnections の実装
**目的**: Neo4j/PostgreSQL接続のモック

**Neo4jモック機能**:
- Cypherクエリの実行シミュレーション
- ノード/リレーションシップの管理
- インデックス操作
- バッチインサート

**PostgreSQLモック機能**:
- SQL実行シミュレーション
- テーブル操作
- トランザクション管理
- メタデータ管理

#### 1.4 MockTransactionManager の実装
**目的**: トランザクション処理のモック

**機能**:
- 分散トランザクションのシミュレーション
- コミット/ロールバック
- 2フェーズコミット
- タイムアウト処理

### Phase 2: インメモリデータストア（1日間）

#### 2.1 InMemoryDataStore の実装
**目的**: 純粋インメモリでの高速データ管理

**基本方針**:
- **依存関係ゼロ**: 標準ライブラリのみ使用
- **高速動作**: 辞書とリストによる直接操作
- **軽量設計**: 最小限のメモリ使用
- **即座にリセット**: テスト間の完全分離

**データ構造**:
```python
class InMemoryDataStore:
    # Neo4j データ
    nodes: Dict[str, Dict[str, Any]]        # {node_id: properties}
    relationships: List[Dict[str, Any]]     # [{source, target, type, props}]
    labels: Dict[str, Set[str]]             # {label: {node_ids}}
    
    # PostgreSQL データ
    tables: Dict[str, List[Dict[str, Any]]] # {table_name: [records]}
    schemas: Dict[str, Dict[str, str]]      # {table: {column: type}}
    
    # 検索・インデックス（簡易）
    text_index: Dict[str, List[str]]        # 全文検索用
    vector_index: Dict[str, List[float]]    # ベクトル検索用
    
    # トランザクション状態
    transaction_log: List[Dict[str, Any]]   # 操作履歴
    active_transactions: Dict[str, Dict]    # 進行中トランザクション
```

#### 2.2 シンプルなクエリ処理
**Neo4j (Cypher風)**:
- **CREATE**: ノード/リレーションシップ作成
- **MATCH**: パターンマッチング（基本のみ）
- **RETURN**: 結果セット生成
- **DELETE**: データ削除

**PostgreSQL (SQL風)**:
- **INSERT**: レコード挿入
- **SELECT**: データ取得（WHERE句基本対応）
- **UPDATE**: データ更新
- **DELETE**: データ削除

**実装方針**: 完全なパーサーは作らず、パラメータベースで処理

### Phase 3: テスト支援機能（1日間）

#### 3.1 設定可能な動作
```python
mock_manager = MockGraphPostgresManager()
mock_manager.configure({
    'neo4j_latency': 100,           # レスポンス遅延(ms)
    'postgres_latency': 50,
    'error_rate': 0.1,              # エラー発生率
    'max_connections': 10,
    'timeout_simulation': True
})
```

#### 3.2 エラーシミュレーション
- 接続エラー
- タイムアウトエラー
- リソース不足エラー
- データ不整合エラー

#### 3.3 アサーション支援
```python
# テストでの使用例
mock_manager.assert_query_called('CREATE (n:Node)')
mock_manager.assert_transaction_committed()
mock_manager.get_call_history()
```

### Phase 4: ドキュメント・サンプル（半日）

#### 4.1 使用例の作成
```python
# 基本的な使用例
from graph_postgres_manager.mocks import MockGraphPostgresManager

async def test_my_feature():
    mock_manager = MockGraphPostgresManager()
    await mock_manager.initialize()
    
    # テストコード
    result = await mock_manager.execute_neo4j_query(
        "MATCH (n) RETURN n"
    )
    
    await mock_manager.close()
```

#### 4.2 設定例の提供
- 典型的なテストシナリオ
- エラーケースのテスト
- パフォーマンステスト用設定

## 技術仕様

### 依存関係
- **完全ゼロ依存**: 標準ライブラリのみ使用
- **Python標準**: typing, asyncio, collections, uuid
- **追加パッケージ**: なし

### パフォーマンス要件（インメモリ特化）
- **メモリ使用量**: 実データの1/20以下（辞書ベース）
- **レスポンス時間**: 実装の1/1000以下（ネットワークなし）
- **初期化時間**: 0.1秒以内（インスタンス化のみ）
- **リセット時間**: 0.01秒以内（辞書クリア）

### 互換性
- **API互換**: 100%（実装と同じインターフェース）
- **Python**: 3.12+
- **async/await**: 完全対応

## 実装スケジュール

### Day 1: 基盤実装
- [ ] ディレクトリ構造作成
- [ ] MockGraphPostgresManager骨格
- [ ] 基本的なConnection mock
- [ ] シンプルなテストケース

### Day 2: 機能実装
- [ ] クエリ実行モック
- [ ] トランザクション管理
- [ ] データストア実装
- [ ] エラーハンドリング

### Day 3: 高度な機能
- [ ] 検索機能モック
- [ ] AST管理モック
- [ ] 設定可能な動作
- [ ] テスト支援機能

### Day 4: 仕上げ
- [ ] ドキュメント作成
- [ ] サンプルコード
- [ ] テストの完成
- [ ] 既存テストとの統合

## 成功指標

### 機能性
- [ ] 全APIメソッドのモック実装完了
- [ ] 既存のユニットテストがモックでも動作
- [ ] エラーケースの正しいシミュレーション

### 使いやすさ
- [ ] 1行でモック有効化可能
- [ ] 設定なしでも基本動作
- [ ] 明確なドキュメント

### パフォーマンス（インメモリ特化）
- [ ] 実装の1000倍以上高速（ネットワークなし）
- [ ] メモリ使用量1/20以下（辞書ベース）
- [ ] 初期化時間0.1秒以内
- [ ] データリセット0.01秒以内

## リスク管理

### 技術リスク（インメモリ特化）
- **複雑なクエリ処理**: パラメータベースの簡易実装
- **大量データ**: 制限事項として明記、テスト用途に特化
- **メモリリーク**: 明示的なクリア機能、弱参照活用
- **状態管理**: 辞書ベースのシンプルな実装

### 保守性リスク
- **API変更の同期**: 自動テストで検出
- **機能差異**: 明確なドキュメント化
- **バグの混入**: 既存テストでの検証

## 追加検討事項

### 将来の拡張（インメモリベース）
- より高度なクエリ処理（正規表現マッチング）
- データエクスポート機能（JSON/CSV）
- メモリ使用量監視
- ベンチマーク比較機能
- 状態スナップショット機能

### 他プロジェクトとの連携
- ast2graphのモック対応
- intent_storeのモック対応
- code_intent_searchのテスト支援

## 品質保証

### テスト戦略
- [ ] モック自体のユニットテスト
- [ ] 実装との動作比較テスト
- [ ] 統合テストでのモック使用
- [ ] エラーケースの検証

### コード品質
- [ ] 型ヒント100%
- [ ] docstring完備
- [ ] Ruffチェック通過
- [ ] カバレッジ90%以上

この計画に基づいて、他プロジェクトでの利用を容易にする高品質なモック実装を提供します。