# コード品質改善および緊急問題対応計画

## 作成日時
2025年7月4日 14:49

## 背景
pytestおよびruffによるコード品質チェックの結果、以下の問題が確認された：

### 緊急度別問題リスト

#### 🔴 緊急（即座に対応必要）
1. **ConnectionErrorのインポートエラー**
   - 問題：`tests/test_exceptions.py`でConnectionErrorがインポートできない
   - 原因：`__init__.py`でエクスポートされていない、またはPythonビルトインと名前が衝突
   - 影響：pytest実行が完全に失敗

2. **pytest実行の完全失敗**
   - 現状：165テスト中、1エラーでコレクション失敗
   - 影響：全テストが実行されない

#### 🟡 重要（24時間以内）
1. **Ruffエラー（24件）**
   - インポート順序の問題（2件）
   - 未使用引数（ARG001/ARG002）（17件）
   - try-except-passの検出（3件）
   - その他のコードスタイル問題（2件）

2. **Mypyエラー（約55件）**
   - PostgreSQL executeメソッドのパラメータ型不一致（多数）
   - Noneチェックの欠如
   - 型アノテーションの不足

## 詳細な問題分析

### 1. ConnectionError問題
```python
# tests/test_exceptions.py:7
from graph_postgres_manager import (
    ConnectionError,  # この名前がPythonビルトインと衝突
)
```

**解決案**：
- `ConnectionError` → `GraphConnectionError`に統一
- 全ての関連ファイルで名前を変更

### 2. Ruffエラー詳細
```python
# 主要な問題パターン：
# 1. 未使用の関数引数（fixtureなど）
tests/integration/conftest.py:108: ARG001 Unused function argument: `clean_neo4j`

# 2. try-except-passパターン
tests/integration/test_connection.py:101: S110 `try`-`except`-`pass` detected

# 3. インポート順序
src/graph_postgres_manager/__init__.py:3: I001 Import block is un-sorted
```

### 3. Mypy型エラー
```python
# PostgreSQL executeメソッドでtupleを渡している箇所
# 期待される型: list[Any] | dict[str, Any] | None
# 実際の型: tuple[str, ...]
```

## 実行計画

### Phase 1: 緊急問題の解決（30分）
1. **ConnectionError名前変更**
   - `src/graph_postgres_manager/exceptions.py`で名前を確認・修正
   - `__init__.py`でエクスポート名を修正
   - 全ての使用箇所を更新

### Phase 2: Ruffエラー修正（1時間）
1. **自動修正可能な問題**
   ```bash
   python3 -m ruff check src/ tests/ --fix
   ```

2. **手動修正が必要な問題**
   - 未使用引数にコメント追加または`_`プレフィックス
   - try-except-passにロギング追加
   - pytest.raisesブロックの簡素化

### Phase 3: Mypy型エラー修正（2時間）
1. **PostgreSQL executeメソッドの修正**
   - tupleをlistに変換
   - 型アノテーションの追加

2. **Noneチェックの追加**
   - Optional型の適切な処理
   - アサーションまたは条件分岐の追加

### Phase 4: テスト実行確認（30分）
1. **pytest再実行**
   ```bash
   python3 -m pytest tests/ -v
   ```

2. **カバレッジ確認**
   ```bash
   python3 -m pytest tests/ --cov=src/graph_postgres_manager
   ```

## 成功基準
1. **pytest**: 全165テストが正常に実行される
2. **ruff**: エラー0件（または意図的な除外のみ）
3. **mypy**: 重大なエラー0件（警告は許容）

## リスクと対策
1. **名前変更の影響範囲**
   - リスク：未発見の使用箇所がある可能性
   - 対策：grepで全体検索、段階的なテスト実行

2. **型修正の副作用**
   - リスク：動作が変わる可能性
   - 対策：単体テストで動作確認

## 次のステップ
1. この計画に従って修正を実施
2. 各フェーズ完了後にテスト実行
3. 完了後、APIドキュメント生成に着手

## 備考
- 統合整備計画（202507041800）の内容を参考に、より具体的な実行計画を策定
- 緊急度の高い問題から順次対応
- CI/CDパイプラインの正常化を最優先とする