# コード品質改善とテスト修正計画

## 作成日時
2025-07-04 16:35

## 現状分析

### 1. テスト実行時のエラー
- `test_exceptions.py`: `ConnectionError`のインポートエラー
  - `graph_postgres_manager`から`ConnectionError`をインポートしようとしているが存在しない
  - Python builtin の`ConnectionError`とのシャドウイング警告もある

### 2. Lint エラー (31件)
主な問題カテゴリ：
- **インポート関連** (6件)
  - 未ソートのインポート
  - builtinのシャドウイング
  - トップレベル以外でのインポート
- **未使用引数** (16件)
  - 関数/メソッドの未使用引数
- **セキュリティ/品質** (9件)
  - `subprocess`呼び出しの検証不足
  - `try-except-pass`の使用
  - ネストした`with`文
  - 長すぎる行

### 3. Pytestマーカー警告
- `pytest.mark.integration`が未登録

## 優先度と対応方針

### 最優先事項（即時対応）
1. **test_exceptions.pyのインポートエラー修正**
   - `ConnectionError`を適切な例外クラスに変更
   - または、カスタム例外として定義

2. **基本的なlintエラーの自動修正**
   - インポートのソート
   - `__all__`のソート

### 高優先度事項
3. **未使用引数の整理**
   - fixtureで必要な引数は`# noqa`で対応
   - 本当に不要な引数は削除

4. **セキュリティ関連の警告対応**
   - `subprocess`呼び出しの安全性確認
   - `try-except-pass`にログ追加

### 中優先度事項
5. **pytestマーカーの設定**
   - `pyproject.toml`に`integration`マーカーを追加

6. **コード品質改善**
   - ネストした`with`文の統合
   - 長い行の分割

## 実装手順

### Step 1: test_exceptions.pyのエラー修正
```python
# 現在のインポート
from graph_postgres_manager import (
    ConfigurationError,
    ConnectionError,  # これが問題
    ...
)

# 修正案
from graph_postgres_manager import (
    ConfigurationError,
    GraphConnectionError,  # または適切な例外クラス
    ...
)
```

### Step 2: 自動修正可能なlintエラーの解決
```bash
python3 -m ruff check . --fix
```

### Step 3: pytestマーカーの設定追加
`pyproject.toml`に以下を追加：
```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
pythonpath = ["."]
markers = [
    "integration: marks tests as integration tests",
]
```

### Step 4: 手動修正が必要なエラーの対応
- セキュリティ警告
- 未使用引数
- その他の品質問題

## 期待される成果
1. 全テストが正常に実行される
2. lintエラーが0件になる
3. コード品質が向上し、保守性が改善される

## リスクと対策
- **リスク**: 大量の変更による既存機能への影響
- **対策**: 段階的な修正とテスト実行による検証

## 完了基準
- [ ] `python3 -m pytest`が全件パス
- [ ] `python3 -m ruff check .`でエラーが0件
- [ ] CI/CDパイプラインが正常に動作