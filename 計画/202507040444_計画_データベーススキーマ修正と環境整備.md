# データベーススキーマ修正と環境整備計画

## 概要
GitHub ActionsでのCI/CDパイプラインを安定化させるため、データベーススキーマの修正と環境設定の整備を行う。

## 背景
- IntentManagerのバグは修正完了したが、GitHub Actionsでintent_ast_mapテーブルが存在しないエラーが発生
- 環境変数関連のテストでCI環境での設定値不一致が発生
- これらの問題によりCI/CDパイプラインが不安定

## 目標
1. GitHub ActionsでのPostgreSQLテスト環境を完全に動作させる
2. 環境変数関連のテストを安定化させる
3. CI/CDパイプラインを100%グリーンにする

## 実施項目

### 1. データベーススキーマ修正（最優先）
#### 1.1 intent_ast_mapテーブル定義の追加
- [ ] scripts/init-postgres.sqlにintent_ast_mapテーブル定義を追加
- [ ] intent_vectorsテーブルの定義も確認・追加
- [ ] インデックス定義の追加（パフォーマンス最適化）

#### 1.2 スキーマバージョン管理
- [ ] マイグレーションスクリプトの作成
- [ ] スキーマバージョンテーブルの追加
- [ ] 既存データベースへの適用手順の文書化

### 2. 環境設定の整備
#### 2.1 テスト環境変数の統一
- [ ] test_config.pyのテストケース修正
- [ ] CI環境での環境変数設定の確認
- [ ] デフォルト値の見直し

#### 2.2 GitHub Actionsワークフロー改善
- [ ] PostgreSQL初期化の待機時間調整
- [ ] Neo4j接続の安定化
- [ ] エラーログの詳細化

### 3. テスト環境の安定化
#### 3.1 統合テストの修正
- [ ] search_unifiedテストのAsyncConnectionエラー修正
- [ ] モック実装の活用によるテスト高速化
- [ ] テストデータの標準化

#### 3.2 テストカバレッジの向上
- [ ] 未テストの機能の洗い出し
- [ ] エッジケースのテスト追加
- [ ] パフォーマンステストの基盤作成

## 実装詳細

### intent_ast_mapテーブル定義
```sql
CREATE TABLE IF NOT EXISTS intent_ast_map (
    id SERIAL PRIMARY KEY,
    intent_id VARCHAR(255) NOT NULL,
    ast_node_id VARCHAR(255) NOT NULL,
    confidence FLOAT DEFAULT 1.0,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(intent_id, ast_node_id)
);

CREATE INDEX idx_intent_ast_map_intent_id ON intent_ast_map(intent_id);
CREATE INDEX idx_intent_ast_map_ast_node_id ON intent_ast_map(ast_node_id);
CREATE INDEX idx_intent_ast_map_confidence ON intent_ast_map(confidence);
```

### intent_vectorsテーブル定義
```sql
CREATE TABLE IF NOT EXISTS intent_vectors (
    id SERIAL PRIMARY KEY,
    intent_id VARCHAR(255) UNIQUE NOT NULL,
    vector_data TEXT NOT NULL,  -- JSON encoded vector
    dimensions INT NOT NULL,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_intent_vectors_intent_id ON intent_vectors(intent_id);
```

## 成功基準
1. GitHub Actionsの全てのワークフローがグリーンになる
2. ローカル環境とCI環境でのテスト結果が一致する
3. 新規開発者が環境構築で躓かない

## リスクと対策
1. **リスク**: 既存環境への影響
   - **対策**: IF NOT EXISTSを使用し、既存環境を破壊しない

2. **リスク**: パフォーマンス劣化
   - **対策**: 適切なインデックスの設定とEXPLAIN分析

3. **リスク**: テストの偽陽性
   - **対策**: モック実装の活用とテストデータの標準化

## スケジュール
- データベーススキーマ修正: 2時間
- 環境設定の整備: 1時間
- テスト環境の安定化: 2時間
- 検証とドキュメント更新: 1時間

合計: 6時間（1営業日以内に完了）

## 次のステップ
このタスク完了後は、コード品質改善（Ruffエラー360件の修正）に着手する。