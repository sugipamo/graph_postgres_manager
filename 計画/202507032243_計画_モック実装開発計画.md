# モック実装開発計画 - graph_postgres_manager

**作成日**: 2025-07-03 22:43  
**対象**: graph_postgres_manager モック機能の実装開発  
**目的**: 他プロジェクトが実際のDBサーバーなしでテストを実行可能にする

## 背景と現状

### 現在の状況
- **本体実装**: ✅ 完了（全機能実装済み）
- **テストカバレッジ**: 75.9%（137テスト中104件成功）
- **統合テスト**: ⚠️ Docker環境の認証設定問題で33件失敗
- **コード品質**: ✅ 大幅改善（Ruffエラー93%削減、31件残存）
- **モック戦略**: 単体テストでunittest.mock使用、独立モック実装なし

### 課題
1. 他プロジェクトがgraph_postgres_managerを使用する際、Neo4j/PostgreSQLサーバーが必要
2. CI/CD環境でのテスト実行が複雑
3. ローカル開発環境のセットアップが煩雑

## 実装計画

### Day 1: 基盤構築（2025-07-04）

#### 1.1 ディレクトリ構造作成
```
src/graph_postgres_manager/
├── mocks/
│   ├── __init__.py           # モックエクスポート
│   ├── manager.py            # MockGraphPostgresManager
│   ├── connections/
│   │   ├── __init__.py
│   │   ├── neo4j.py          # MockNeo4jConnection
│   │   └── postgres.py       # MockPostgresConnection
│   ├── transactions.py       # MockTransactionManager
│   ├── search.py            # MockSearchManager
│   └── store.py             # InMemoryDataStore
```

#### 1.2 InMemoryDataStore実装
- **設計方針**: 標準ライブラリのみ使用、高速動作
- **データ構造**:
  ```python
  @dataclass
  class InMemoryDataStore:
      # グラフデータ
      nodes: Dict[str, Dict[str, Any]]
      edges: List[Dict[str, Any]]
      node_labels: Dict[str, Set[str]]
      
      # リレーショナルデータ
      tables: Dict[str, List[Dict[str, Any]]]
      schemas: Dict[str, Dict[str, str]]
      indexes: Dict[str, List[str]]
      
      # 検索インデックス
      text_index: Dict[str, List[Tuple[str, float]]]
      vector_store: Dict[str, List[float]]
      
      # トランザクション
      tx_log: List[Dict[str, Any]]
      active_tx: Dict[str, Any]
  ```

#### 1.3 MockGraphPostgresManager基本実装
- GraphPostgresManagerと同じインターフェース
- 非同期メソッドの実装
- 設定可能な動作（レイテンシ、エラー率）

### Day 2: コア機能実装（2025-07-05）

#### 2.1 MockConnections実装
**MockNeo4jConnection**:
- Cypherクエリの簡易パース（CREATE, MATCH, RETURN）
- ノード・エッジ操作
- バッチインサート対応

**MockPostgresConnection**:
- SQL文の簡易パース（INSERT, SELECT, UPDATE, DELETE）
- テーブル操作
- トランザクション境界管理

#### 2.2 MockTransactionManager実装
- 2フェーズコミットのシミュレーション
- ロールバック機能
- 分離レベルの模擬

#### 2.3 基本的なテスト作成
- モック自体のユニットテスト
- 実装との互換性テスト

### Day 3: 高度な機能（2025-07-06）

#### 3.1 MockSearchManager実装
- グラフ検索の模擬（BFS/DFS）
- テキスト検索（簡易マッチング）
- ベクトル検索（コサイン類似度）
- 統合検索結果のランキング

#### 3.2 AST/Intent統合機能
- store_ast_graphのモック実装
- link_intent_to_astのモック実装
- 検索機能との統合

#### 3.3 エラーシミュレーション
- 接続タイムアウト
- 認証エラー
- リソース不足
- ネットワーク障害

### Day 4: 統合とドキュメント（2025-07-07）

#### 4.1 既存テストとの統合
- conftest.pyへのモックオプション追加
- 環境変数による切り替え
- CI/CDでの利用

#### 4.2 ドキュメント作成
- 使用方法ガイド
- API互換性マトリックス
- 制限事項と回避策

#### 4.3 サンプルコード
- 基本的な使用例
- テストシナリオ例
- パフォーマンステスト例

## 実装の優先順位

### 必須機能（MVP）
1. ✅ 基本的なCRUD操作
2. ✅ トランザクション管理
3. ✅ 接続管理の模擬
4. ✅ エラーハンドリング

### 重要機能
1. ⏳ 検索機能（基本）
2. ⏳ バッチ操作
3. ⏳ メタデータ管理

### 追加機能
1. ⏸️ 高度な検索
2. ⏸️ パフォーマンス計測
3. ⏸️ デバッグ支援

## 技術的な実装詳細

### クエリ処理の簡易実装
```python
class SimpleCypherParser:
    def parse_create(self, query: str) -> Dict[str, Any]:
        # CREATE (n:Label {prop: value}) の解析
        # 正規表現でパラメータ抽出
        pass
    
    def parse_match(self, query: str) -> Dict[str, Any]:
        # MATCH (n:Label) WHERE n.prop = value の解析
        # 基本的なパターンマッチングのみ
        pass
```

### データ操作の実装
```python
class InMemoryGraphOperations:
    def create_node(self, node_id: str, labels: List[str], 
                   properties: Dict[str, Any]) -> None:
        self.store.nodes[node_id] = properties
        for label in labels:
            self.store.node_labels.setdefault(label, set()).add(node_id)
    
    def find_nodes(self, label: Optional[str] = None, 
                  properties: Optional[Dict[str, Any]] = None) -> List[Dict]:
        # シンプルなフィルタリング実装
        pass
```

## 成功基準

### 機能要件
- [ ] GraphPostgresManagerの全パブリックAPIをカバー
- [ ] 既存の単体テストが全てパス
- [ ] 新規プロジェクトでの利用が可能

### 非機能要件
- [ ] 初期化時間: 0.1秒以内
- [ ] メモリ使用量: 実装の1/20以下
- [ ] レスポンス時間: 実装の1/1000以下

### 品質基準
- [ ] テストカバレッジ: 90%以上
- [ ] Ruffエラー: 0件
- [ ] 型ヒント: 100%
- [ ] ドキュメント: 全パブリックAPIに記載

## リスクと対策

### リスク1: API互換性の維持
- **対策**: 実装クラスを継承し、abstractメソッドをオーバーライド
- **検証**: 自動テストでAPI互換性をチェック

### リスク2: 複雑なクエリのサポート
- **対策**: 基本機能に限定し、制限事項を明確に文書化
- **回避策**: パラメータ化されたクエリの推奨

### リスク3: パフォーマンス劣化
- **対策**: プロファイリングと最適化
- **基準**: 単純操作で1ms以内のレスポンス

## まとめ

このモック実装により、graph_postgres_managerを使用するプロジェクトが：
1. DBサーバーなしでテスト実行可能
2. CI/CD環境での高速テスト
3. ローカル開発の簡素化

を実現できます。実装は4日間で完了予定です。