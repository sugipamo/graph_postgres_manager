# IntentManagerバグ修正とコード品質改善計画

## 概要
現在、graph_postgres_managerプロジェクトは96.6%のテスト成功率を達成していますが、IntentManagerに4件の重要なバグがあり、また320件のコード品質問題が残っています。本計画では、これらの問題を体系的に解決し、プロジェクトの品質を本番環境レベルまで引き上げます。

## 現状分析

### 1. IntentManagerのバグ（優先度: 最高）
- **問題**: PostgreSQL結果セットのタプルインデックスエラー
- **影響範囲**: 4件のユニットテスト失敗
- **症状**: `tuple index out of range`エラー
- **原因**: PostgreSQLクエリ結果の処理方法が不適切

### 2. コード品質問題（優先度: 高）
- **Ruffエラー**: 320件（772件から59%削減済み）
- **主な問題**:
  - 例外クラス名にErrorサフィックスが必要
  - インポート順序の問題
  - 未使用インポート
  - 相対インポートから絶対インポートへの変換が必要
  
### 3. CI/CDパイプライン（優先度: 高）
- GitHub Actionsでのビルドが失敗
- Ruffによるlint checkが通らない
- テスト環境の不安定性

## 実装計画

### Phase 1: IntentManagerバグ修正（1日）

#### 1.1 問題の詳細調査
- [ ] 失敗しているテストケースの特定
- [ ] PostgreSQL結果セットの形式確認
- [ ] タプルアクセスパターンの分析

#### 1.2 バグ修正
- [ ] IntentManager.link_intent_to_astメソッドの修正
- [ ] IntentManager.get_ast_nodes_by_intentメソッドの修正
- [ ] IntentManager.search_ast_by_intent_vectorメソッドの修正
- [ ] その他影響を受けるメソッドの修正

#### 1.3 テスト修正と検証
- [ ] ユニットテストの修正
- [ ] 統合テストの追加
- [ ] エッジケースのテスト追加

### Phase 2: コード品質改善（3日）

#### 2.1 例外クラス名の修正
- [ ] すべての例外クラスにErrorサフィックスを追加
- [ ] 例外使用箇所の更新
- [ ] テストケースの更新

#### 2.2 インポート文の整理
- [ ] インポート順序の標準化（標準ライブラリ → サードパーティ → ローカル）
- [ ] 未使用インポートの削除
- [ ] 相対インポートから絶対インポートへの変換

#### 2.3 その他のコード品質問題
- [ ] 型ヒントの更新（Python 3.12対応）
- [ ] docstringの追加・更新
- [ ] 複雑なメソッドのリファクタリング

### Phase 3: CI/CD修復（1日）

#### 3.1 GitHub Actions設定の更新
- [ ] Ruff設定の最適化
- [ ] テスト環境の安定化
- [ ] キャッシュ戦略の改善

#### 3.2 開発環境の標準化
- [ ] pre-commitフックの設定
- [ ] 開発者向けドキュメントの更新
- [ ] ローカル環境でのlint/test手順の文書化

## 成功指標

### 定量的指標
- **テスト成功率**: 100%（117/117テスト）
- **Ruffエラー**: 0件
- **型チェックエラー**: 0件
- **CI/CDパイプライン**: すべてグリーン

### 定性的指標
- コードの可読性向上
- 保守性の改善
- 開発者体験の向上

## リスクと対策

### リスク1: バグ修正による新たなバグ
- **対策**: 包括的なテストケースの追加
- **対策**: 段階的な修正とテスト

### リスク2: 大規模なコード変更による混乱
- **対策**: 小さなPRに分割
- **対策**: レビュープロセスの徹底

### リスク3: 既存機能への影響
- **対策**: 統合テストの充実
- **対策**: ステージング環境での検証

## タイムライン

### Day 1（2025-07-04）
- AM: IntentManagerバグの調査と修正
- PM: テストの修正と検証

### Day 2-3（2025-07-05〜06）
- 例外クラス名の一括修正
- インポート文の整理

### Day 4（2025-07-07）
- その他のコード品質問題の修正
- ドキュメントの更新

### Day 5（2025-07-08）
- CI/CD設定の修正
- 最終テストと検証

## 期待される成果

1. **即時的成果**
   - すべてのテストが成功
   - CI/CDパイプラインの正常動作
   - コード品質基準の達成

2. **中期的成果**
   - 開発速度の向上
   - バグの早期発見
   - 新規開発者のオンボーディング時間短縮

3. **長期的成果**
   - プロジェクトの信頼性向上
   - コミュニティからの信頼獲得
   - 本番環境での安定稼働

## 実装優先順位

1. **最優先**: IntentManagerのバグ修正（本日中）
2. **高優先**: 例外クラス名の修正（明日）
3. **中優先**: インポート文の整理（2日後）
4. **低優先**: その他のコード品質改善（3日後）

## 備考

- IntentManagerのバグは、他のプロジェクトとの統合に影響するため最優先で対応
- コード品質改善は、将来的なPyPI公開を見据えて実施
- CI/CD修復により、継続的な品質維持を実現