# graph_postgres_manager ロードマップ

## プロジェクト概要
Neo4jとPostgreSQLの統合管理を行い、グラフデータとリレーショナルデータの一貫性を保証するデータ管理ライブラリ

## 開発フェーズ

### Phase 1: 基礎実装（2週間）
- [x] 接続管理基盤の実装
  - [x] ConnectionConfigデータクラスの作成
  - [x] コネクションプールの実装
  - [x] 自動再接続機能の実装
- [x] Neo4jアダプターの実装
  - [x] Neo4jDriverのラッパー作成
  - [x] バッチインポート機能
  - [x] Cypherクエリ実行管理
- [x] PostgreSQLアダプターの実装
  - [x] psycopgのラッパー作成
  - [x] SQL実行管理
  - [x] メタデータ管理機能【2025-01-03実装完了】

### Phase 2: 統合機能（2週間）
- [x] トランザクション管理の実装
  - [x] 2フェーズコミットプロトコル
  - [x] ロールバック機能
  - [ ] デッドロック検出・回避【未実装】
- [ ] データ整合性保証機能【未実装】
  - [ ] 整合性チェック機能【未実装】
  - [ ] データ同期機能【未実装】
  - [ ] 障害時の自動復旧【未実装】
- [x] エラーハンドリングの実装
  - [x] 例外体系の定義
  - [x] リトライ戦略の実装
  - [ ] サーキットブレーカーパターン【未実装】

### Phase 3: 運用機能（1週間）
- [ ] バックアップ・リストア機能【未実装】
  - [ ] データベースのバックアップ【未実装】
  - [ ] スナップショットのエクスポート【未実装】
  - [ ] リストア機能【未実装】
- [x] 監視・ヘルスチェック機能
  - [x] ヘルスチェック基本機能
  - [ ] パフォーマンスメトリクス収集【未実装】
  - [ ] データ整合性レポート【未実装】
  - [ ] ストレージ統計情報【未実装】
- [ ] パフォーマンス最適化【未実装】
  - [ ] クエリ最適化【未実装】
  - [ ] インデックス管理【未実装】
  - [ ] バッチ処理の最適化【未実装】

### Phase 4: API実装とテスト（1週間）
- [x] Public APIの実装
  - [x] GraphPostgresManagerクラス
  - [ ] 統合検索機能【未実装】
  - [x] バッチ操作API
  - [ ] ast2graphデータ受け取りAPI（store_ast_graph）【未実装】
  - [ ] 意図-AST関連付けAPI（link_intent_to_ast）【未実装】
- [x] テストの実装
  - [x] ユニットテスト（基本実装完了）
  - [x] 統合テスト（基本実装完了）
  - [ ] パフォーマンステスト【未実装】

## 技術仕様
- Python: >=3.12
- Neo4j Database: 5.x系
- PostgreSQL: 15以上（pgvector対応）
- 主要ライブラリ:
  - neo4j>=5.28.0
  - psycopg[binary]>=3.1
  - asyncio

## 成功指標
- 書き込み性能: 10,000ノード/秒以上
- クエリ応答: 単純クエリ100ms以内
- 可用性: 99.9%以上
- データ整合性: 100%保証

## 現在の進捗状況
### 完了済み
- Phase 1: 基礎実装の全て【完了】
  - ConnectionConfigデータクラスの実装
  - Neo4jConnection、PostgresConnectionクラスの実装
  - コネクションプール機能（PostgreSQL）
  - 自動再接続機能の実装
  - バッチ操作API（batch_insert_neo4j、batch_insert_postgres）
- GraphPostgresManagerクラスの実装
  - 統一的なインターフェース
  - 非同期コンテキストマネージャー対応
  - 設定情報の取得（マスキング機能付き）
- ヘルスチェック基本機能
  - 定期的なヘルスチェックループ
  - 接続状態の監視
  - 自動再接続との統合
- エラーハンドリングの基本実装
  - 例外階層の定義（GraphPostgresManagerException等）
  - リトライデコレータの実装
- テスト環境とCI/CD（2025-01-02完了）
  - Docker環境の構築（docker-compose.yml）
  - 統合テストの基本実装
  - GitHub Actionsワークフローの設定
  - Makefileによる開発環境の整備
- トランザクション管理（2025-01-02完了）
  - 2フェーズコミットプロトコルの実装
  - 分散トランザクションの整合性保証
  - ロールバック機能の実装
- PostgreSQLメタデータ管理機能（2025-01-03完了）
  - SchemaManagerクラスの実装（スキーマ情報管理、マイグレーション）
  - IndexManagerクラスの実装（インデックス管理、最適化提案）
  - StatsCollectorクラスの実装（統計情報収集、レポート生成）
  - GraphPostgresManagerへの統合（Public API）

### 次のステップ（優先順位順）
~~1. テスト環境の構築【完了済み】~~
   ~~- [x] DockerでNeo4jとPostgreSQLのテスト環境構築~~
   ~~- [x] docker-compose.ymlの作成~~
   ~~- [x] 統合テストの実装~~
   ~~- [x] CI/CDパイプラインの設定（GitHub Actions）~~

~~2. トランザクション管理の実装【完了済み】~~
   ~~- [x] 2フェーズコミットプロトコルの実装~~
   ~~- [x] 分散トランザクションの整合性保証~~
   ~~- [x] ロールバック機能の実装~~
   ~~- [x] GraphPostgresManagerへの統合~~

~~3. メタデータ管理とスキーマ管理【完了済み】~~
   ~~- [x] PostgreSQLのメタデータ管理機能~~
   ~~- [x] スキーママイグレーション機能~~
   ~~- [x] インデックス自動生成~~

4. パフォーマンス最適化
   - クエリ最適化機能
   - 接続プールの最適化
   - バッチ処理の並列化

5. 運用機能の強化
   - バックアップ・リストア機能
   - パフォーマンスメトリクス収集
   - サーキットブレーカーパターンの実装

6. ast2graph統合機能の実装
   - store_ast_graphメソッドの実装
   - ast2graph出力形式の検証機能
   - グラフデータのバリデーション

7. intent_store連携機能の実装
   - link_intent_to_astメソッドの実装
   - 意図-ASTマッピングテーブルの設計
   - 関連データの整合性保証

## 今後の課題
- ドキュメントの充実（API仕様書、使用例）
- エラーメッセージの国際化対応
- プラグインアーキテクチャの検討
- セキュリティ監査とベストプラクティスの適用

## 今後追加予定の機能
### 高優先度
~~1. **PostgreSQLメタデータ管理機能**【2025-01-03完了】~~
   ~~- スキーマ情報の管理と自動同期~~
   ~~- インデックス情報の管理~~
   ~~- テーブル統計情報の収集~~

2. **ast2graph連携API (store_ast_graph)**
   - ASTグラフデータの受け取りと検証
   - Neo4jへの効率的なバッチインポート
   - グラフ構造の整合性チェック

3. **intent_store連携API (link_intent_to_ast)**  
   - 意図データとASTノードのマッピング
   - PostgreSQLでの関連テーブル管理
   - 双方向検索の最適化

### 中優先度
4. **デッドロック検出・回避機能**
   - 分散トランザクションでのデッドロック検出
   - タイムアウトベースの回避戦略
   - ロック順序の最適化

5. **データ整合性保証機能**
   - 定期的な整合性チェックジョブ
   - 不整合データの検出と報告
   - 自動修復機能（設定可能）

6. **パフォーマンスメトリクス収集**
   - クエリ実行時間の記録
   - リソース使用状況の監視
   - ボトルネック分析レポート

### 低優先度
7. **バックアップ・リストア機能**
   - 増分バックアップ対応
   - ポイントインタイムリカバリ
   - クロスデータベース整合性保証

8. **高度なクエリ最適化**
   - クエリプランのキャッシュ
   - 実行計画の分析と改善提案
   - 自動インデックス推奨

## 備考
- ast2graphライブラリからのグラフデータを受け取ることを想定
- intent_storeライブラリとの連携を考慮した設計
- code_intent_searchライブラリからの利用を想定したAPIを提供