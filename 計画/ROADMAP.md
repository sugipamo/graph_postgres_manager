# graph_postgres_manager ロードマップ

## プロジェクト概要
Neo4jとPostgreSQLの統合管理を行い、グラフデータとリレーショナルデータの一貫性を保証するデータ管理ライブラリ

### Code-Smithプロジェクトでの位置づけ
本ライブラリは、Code-Smithプロジェクトの分離型アーキテクチャにおけるデータ管理層として機能します：
- **責務**: Neo4j（グラフDB）とPostgreSQL（RDB）の統合管理、トランザクション保証
- **連携ライブラリ**: ast2graph（AST構造提供）、intent_store（意図管理）、code_intent_search（統合検索）
- **特徴**: 2つのDBシステム間でのACIDトランザクション、データ整合性保証、運用管理機能

## 開発フェーズ

### Phase 1: 基礎実装（2週間）✓
- [x] 接続管理基盤の実装 ✓
  - [x] ConnectionConfigデータクラスの作成
  - [x] コネクションプールの実装
  - [x] 自動再接続機能の実装
- [x] Neo4jアダプターの実装 ✓
  - [x] Neo4jDriverのラッパー作成
  - [x] バッチインポート機能
  - [x] Cypherクエリ実行管理
- [x] PostgreSQLアダプターの実装 ✓
  - [x] psycopgのラッパー作成
  - [x] SQL実行管理
  - [x] メタデータ管理機能【2025-01-03実装完了】

### Phase 2: 統合機能（2週間）【一部完了】
- [x] トランザクション管理の実装 ✓
  - [x] 2フェーズコミットプロトコル
  - [x] ロールバック機能
  - [ ] デッドロック検出・回避【未実装】
- [ ] データ整合性保証機能【一部実装】
  - [x] 基本的な整合性チェック機能【実装済み】
  - [ ] データ同期機能【未実装】
  - [ ] 障害時の自動復旧【未実装】
- [x] エラーハンドリングの実装 ✓
  - [x] 例外体系の定義
  - [x] リトライ戦略の実装
  - [x] サーキットブレーカーパターン【2025-07-03確認：BaseConnectionで実装済み】

### Phase 3: 運用機能（1週間）
- [ ] バックアップ・リストア機能【未実装】
  - [ ] データベースのバックアップ【未実装】
  - [ ] スナップショットのエクスポート【未実装】
  - [ ] リストア機能【未実装】
- [x] 監視・ヘルスチェック機能【一部実装】
  - [x] ヘルスチェック基本機能【実装済み】
  - [x] パフォーマンスメトリクス収集【StatsCollectorで実装済み】
  - [ ] データ整合性レポート【未実装】
  - [x] ストレージ統計情報【StatsCollectorで実装済み】
- [x] パフォーマンス最適化【一部実装】
  - [ ] クエリ最適化【基本機能のみ】
  - [x] インデックス管理【IndexManagerで実装済み】
  - [ ] バッチ処理の最適化【未実装】

### Phase 4: API実装とテスト（1週間）✅ 完了
- [x] Public APIの実装 ✓
  - [x] GraphPostgresManagerクラス
  - [x] 統合検索機能【実装済み：SearchManager・search_unifiedメソッド実装完了】
  - [x] バッチ操作API
  - [x] ast2graphデータ受け取りAPI（store_ast_graph）✓
  - [x] 意図-AST関連付けAPI（link_intent_to_ast）✓
- [x] テストの実装【基本実装完了】
  - [x] ユニットテスト ✓
  - [x] 統合テスト ✓
  - [ ] パフォーマンステスト【未実装】

## 技術仕様
- Python: >=3.12
- Neo4j Database: 5.x系
- PostgreSQL: 15以上（pgvector対応）
- 主要ライブラリ:
  - neo4j>=5.28.0
  - psycopg[binary]>=3.1
  - asyncio

## 実装済みアーキテクチャ要素
- **例外階層**: 14種類の専門的な例外クラス（GraphPostgresManagerException基底）
- **サーキットブレーカーパターン**: BaseConnectionクラスで実装
- **DDLハンドリング**: PostgreSQL DDL文の適切な処理
- **非同期アーキテクチャ**: asyncio基盤の非同期処理
- **メタデータ管理**: SchemaManager、IndexManager、StatsCollector
- **統合検索**: SearchManagerによるグラフ・ベクトル・全文検索の統合

## 成功指標
- 書き込み性能: 10,000ノード/秒以上
- クエリ応答: 単純クエリ100ms以内
- 可用性: 99.9%以上
- データ整合性: 100%保証

## 現在の進捗状況
### 完了済み
- ヘルスチェック機能（2025-01-03実装）
  - 定期的な自動ヘルスチェックループ（_health_check_loop）
  - Neo4jとPostgreSQLの接続状態監視
  - 自動再接続機能との統合
  - get_connection_status()メソッド（詳細接続情報）
  - get_config_info()メソッド（機密情報マスキング付き）
- Phase 1: 基礎実装の全て【完了】
  - ConnectionConfigデータクラスの実装
  - Neo4jConnection、PostgresConnectionクラスの実装
  - コネクションプール機能（PostgreSQL）
  - 自動再接続機能の実装
  - バッチ操作API（batch_insert_neo4j、batch_insert_postgres）
- GraphPostgresManagerクラスの実装
  - 統一的なインターフェース
  - 非同期コンテキストマネージャー対応
  - 設定情報の取得（マスキング機能付き）
- ヘルスチェック基本機能
  - 定期的なヘルスチェックループ
  - 接続状態の監視
  - 自動再接続との統合
- エラーハンドリングの基本実装
  - 例外階層の定義（GraphPostgresManagerException等）
  - リトライデコレータの実装
- テスト環境とCI/CD（2025-01-02完了）
  - Docker環境の構築（docker-compose.yml）
  - 統合テストの基本実装
  - GitHub Actionsワークフローの設定
  - Makefileによる開発環境の整備
- トランザクション管理（2025-01-02完了）
  - 2フェーズコミットプロトコルの実装
  - 分散トランザクションの整合性保証
  - ロールバック機能の実装
- PostgreSQLメタデータ管理機能（2025-01-03完了）
  - SchemaManagerクラスの実装（スキーマ情報管理、マイグレーション）
  - IndexManagerクラスの実装（インデックス管理、最適化提案）
  - StatsCollectorクラスの実装（統計情報収集、レポート生成）
  - GraphPostgresManagerへの統合（Public API）
- コード品質改善とテスト修正（2025-01-03完了）
  - Ruffによる772件のコード品質問題の修正
  - 失敗していた7件のユニットテストの修正
  - Python 3.12対応の型ヒント更新
  - テスト環境での依存関係解決
- ast2graph統合機能の実装（2025-01-03完了）
  - store_ast_graphメソッドの実装（GraphPostgresManagerクラス）
  - ast2graph出力形式の検証機能（_validate_ast_graphメソッド）
  - グラフデータのバリデーション
  - バッチインポートの最適化（1,000ノード/バッチ）
  - ノード・エッジの整合性チェック機能
  - APOC非対応環境でのフォールバック処理
- intent_store連携機能の実装（2025-07-03完了）
  - IntentManagerクラスの実装（intent/manager.py）
  - IntentMapping、IntentVectorモデルの定義
  - link_intent_to_astメソッドの実装
  - get_ast_nodes_by_intentメソッドの実装
  - search_ast_by_intent_vectorメソッドの実装（pgvector対応）
  - remove_intent_mappingメソッドの実装
  - intent_ast_map、intent_vectorsテーブルの設計
  - GraphPostgresManagerへの統合（Public API）
  - ユニットテスト・統合テストの実装

### 完了した機能（2025-07-03更新）
- **code_intent_search統合機能の実装**【✅ 完了】
   - 統合検索APIの実装（search_unifiedメソッド）✅
   - SearchManagerクラスの実装 ✅
   - グラフ・ベクトル・全文検索の組み合わせ ✅
   - ランキング機能の実装 ✅
   - 検索結果の統合とスコアリング ✅
   - Code-Smithプロジェクトの統合検索インターフェース提供 ✅
   - 包括的なユニットテストの実装 ✅
- **コード品質改善（2025-07-03）**【✅ 大幅改善】
   - Ruffエラー59%削減（466件→191件→200件）✅
   - psycopg.PoolTimeoutエラーの修正 ✅
   - Neo4j認証エラーのexponential backoff実装 ✅
   - 相対インポートの修正（30件）✅
   - Ruff設定の新形式への移行 ✅

### 次のステップ（優先順位順）【2025-07-03更新】

1. **モック実装の開発**【最優先・NEW】
   - MockGraphPostgresManagerクラスの実装
   - インメモリデータストアの構築（依存関係ゼロ）
   - トランザクション管理のモック化
   - 他プロジェクトでの利用を容易にする設計
   - 計画詳細: 202507032300_計画_モック実装計画.md

2. **Docker環境の認証設定修正**【優先度高】
   - 統合テストの認証エラー解決（33件のテストが失敗）
   - Neo4j/PostgreSQLの認証情報統一
   - 環境変数とdocker-compose.ymlの整合性確保
   - テスト環境設定の文書化

3. **残存コード品質問題の解決**【優先度中】
   - 31件のRuffエラーの修正
   - SIM117（ネストしたwith文）の解消
   - B904（例外チェーン）の実装
   - コード品質基準の文書化

4. **データ整合性保証機能の強化**
   - 定期的な整合性チェックジョブ
   - 不整合データの検出と報告
   - 自動修復機能（設定可能）
   - データ同期機能

3. **デッドロック検出・回避**
   - 分散トランザクションでのデッドロック検出
   - タイムアウトベースの回避戦略
   - ロック順序の最適化

4. **パフォーマンス最適化**
   - クエリ最適化機能の強化
   - 接続プールの最適化
   - バッチ処理の並列化
   - 実行計画の分析と改善提案

5. **運用機能の強化**
   - バックアップ・リストア機能
   - サーキットブレーカーパターンの実装
   - 障害時の自動復旧機能

6. **テストカバレッジの改善**
   - パフォーマンステストの実装
   - カバレッジレポートの生成と分析
   - 結合テストの拡充

## 今後の課題
- ドキュメントの充実（API仕様書、使用例）
- エラーメッセージの国際化対応
- プラグインアーキテクチャの検討
- セキュリティ監査とベストプラクティスの適用
- パフォーマンステストの実装と最適化
- 長期運用時のメモリリーク対策
- 大規模データセットでのストレステスト

## ~~今後追加予定の機能~~【不要マーク】✅

## 現在の課題（2025-07-03時点）
- **テスト失敗率**: 24.1%（137テスト中33件が失敗/エラー） ✅ 改善中
  - 統合テストのNeo4j/PostgreSQL認証エラー（Docker環境の認証設定問題）
  - 非同期接続プールのイベントループエラー
  - 環境変数/認証情報の不整合
- **コード品質**: 31件のRuffエラー ✅ 大幅改善（466件→31件、93%削減）
  - SIM117（ネストしたwith文）: 7件
  - B904（例外チェーン未使用）: 5件
  - その他: 19件
- **モック実装**: 計画済み、未実装

## 現在の実装状況サマリー（2025-07-03更新）
- **フェーズ1**: ✅ 完了（基礎実装すべて完了）
- **フェーズ2**: ⚠️ 一部完了（サーキットブレーカー実装済み、デッドロック検出未実装）
- **フェーズ3**: ⚠️ 一部実装（ヘルスチェック・メトリクス収集実装済み、バックアップ/リストア未実装）
- **フェーズ4**: ✅ 完了（統合検索機能含む全てのPublic API実装完了）
- **テスト環境**: ⚠️ 要修正（Docker環境の認証設定問題により統合テストが失敗）
- **コード品質**: ✅ 大幅改善（31件のコード品質問題、466件から93%削減）
- **テストカバレッジ**: 75.9%（137テスト中104件成功）
- **モック実装**: 📋 計画済み（2025-07-03）、未実装
- **統合状況**: 
  - ast2graph統合: ✅ 完了
  - intent_store統合: ✅ 完了
  - code_intent_search統合: ✅ 完了（2025-01-03）

## 備考
- ast2graphライブラリからのグラフデータを受け取るstore_ast_graphメソッド実装済み
- intent_storeライブラリとの連携機能実装済み（link_intent_to_astメソッド）
- code_intent_searchライブラリとの統合機能実装済み（search_unifiedメソッド）
- 2025-01-03時点で全ての統合機能（ast2graph、intent_store、code_intent_search）が完了
- SearchManagerクラスによる統合検索機能の提供
- グラフ検索、ベクトル検索、全文検索の統合とランキング機能実装済み
- プロジェクトはCI/CD環境が整備され、包括的なテストカバレッジを維持
- Docker環境でのローカル開発・テスト環境が利用可能