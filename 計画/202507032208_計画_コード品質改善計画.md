# コード品質改善計画書

作成日時: 2025-07-03 22:08
ステータス: 🔴 未着手

## 検出された問題の概要

### 1. pytest結果
- **実行結果**: 154テスト中1件失敗
- **失敗内容**: `tests/test_config.py::TestConnectionConfig::test_default_config`
  - 期待値: `('neo4j', 'password')`
  - 実際値: `('neo4j', 'testpassword')`
  - 原因: 環境変数によるデフォルト値の上書き

### 2. mypy結果
- **エラー数**: 約60件
- **主な型エラー**:
  - 型の不一致: `int`と`str`の混在
  - Noneチェック不足: Optional型の処理漏れ
  - パラメータ型の不整合: 特にPostgreSQL接続のexecute関数
  - 未注釈の変数: 型ヒントの欠落

### 3. ruff結果
- **エラー数**: 163件（うち129件は自動修正可能）
- **主な問題**:
  - 命名規約違反: Exception名のサフィックス不足
  - 複雑度: 分岐が多すぎる関数（16 > 12）
  - 型アノテーション: 古い型ヒントの使用（Dict → dict）
  - インポート順序: 未整理のインポート文
  - エラーハンドリング: raise...from構文の未使用

## 優先度別対応計画

### 優先度1: 高（即時対応必要）

#### 1.1 テスト失敗の修正
**ファイル**: `tests/test_config.py`
**対応内容**:
- 環境変数を考慮したテストケースに修正
- または環境変数をモックして固定値でテスト

#### 1.2 型エラーの修正
**重要ファイル**:
- `src/graph_postgres_manager/models/ast.py:38`
- `src/graph_postgres_manager/connections/neo4j.py`
- `src/graph_postgres_manager/connections/postgres.py`

**対応内容**:
- 型の不一致を修正
- Noneチェックを追加
- execute関数のパラメータ型を統一

### 優先度2: 中（品質向上）

#### 2.1 ruff自動修正の適用
```bash
ruff check src --fix
```

#### 2.2 複雑度の改善
**対象関数**:
- `manager.py:store_ast_graph()` (分岐数: 16)
- `manager.py:_validate_ast_graph()` (分岐数: 16)

**対応内容**:
- 関数の分割によるリファクタリング
- バリデーションロジックの整理

#### 2.3 例外処理の改善
**対応内容**:
- `raise ... from e`構文の使用
- 適切なログ出力の追加

### 優先度3: 低（長期改善）

#### 3.1 型アノテーションの近代化
- `Dict` → `dict`
- `List` → `list`
- `Optional[X]` → `X | None`

#### 3.2 命名規約の統一
- `GraphPostgresManagerException` → `GraphPostgresManagerError`

## 実装手順

### Phase 1: 即時修正（1時間）
1. [ ] テスト失敗の修正
2. [ ] 重要な型エラーの修正
3. [ ] ruff自動修正の適用

### Phase 2: リファクタリング（2時間）
1. [ ] 複雑な関数の分割
2. [ ] エラーハンドリングの改善
3. [ ] 型アノテーションの更新

### Phase 3: 品質保証（30分）
1. [ ] 全テストの再実行
2. [ ] mypy/ruffの再チェック
3. [ ] 修正内容のレビュー

## 成功指標

- ✅ pytestが全て成功（154/154）
- ✅ mypyエラーが0件
- ✅ ruffエラーが0件（または許容範囲内）
- ✅ 関数の複雑度が基準値以下（分岐数 ≤ 12）

## リスクと対策

### リスク
1. 大規模な型修正による新たなバグの混入
2. リファクタリングによる既存機能への影響

### 対策
1. 段階的な修正とテストの実施
2. 機能単位での修正と検証
3. 変更のレビューとドキュメント化

## 備考

- 環境依存の問題（mypy権限エラー）は開発環境の設定確認が必要
- モック実装部分は型チェックが緩いため、今後の改善対象
- 統合テストのマーカー警告は設定追加で解決可能